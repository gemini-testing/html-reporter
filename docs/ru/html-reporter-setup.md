# Подключение плагина

## Обзор

Используйте плагин [html-reporter][html-reporter], чтобы получить html-отчет о прогоне тестов.

:warning: _Для корректной работы плагина html-reporter требуется [hermione][hermione] версии 4 и выше._

Плагин сохраняет результаты прогона тестов в базу данных [SQLite][sqlite]. Поэтому вы не сможете открыть локальный отчет как файл с помощью `file://` протокола.

Чтобы посмотреть отчет, запустите гермиону в GUI-режиме:

```bash
npx hermione gui
```

Или запустите [http-server][http-server] в папке с отчетом:

```bash
npx http-server -p 8000
```

Если вы запускаете локальный сервер не из папки с отчетом, то укажите путь к отчету:

```bash
npx http-server ./hermione-report -p 8000
```

После чего откройте страницу `http://localhost:8000` в браузере.

## Установка

```bash
npm install -D html-reporter
```

## Настройка

Необходимо подключить плагин в разделе `plugins` конфига `hermione`:

**Минимальный конфиг**

```javascript
module.exports = {
    plugins: {
        'html-reporter/hermione': {
            enabled: true
        },

        // другие плагины гермионы...
    },

    // другие настройки гермионы...
};
```

**Максимальный конфиг**

```javascript
module.exports = {
    plugins: {
        'html-reporter/hermione': {
            enabled: true,
            path: 'my/hermione-reports',
            uiMode: 'new',
            defaultView: 'all',
            baseHost: 'test.com',
            errorPatterns: [
                'Parameter .* must be a string',
                {
                    name: 'Cannot read property of undefined',
                    pattern: 'Cannot read property .* of undefined',
                    hint: '<div>google it, i dont know how to fix it =(</div>'
                }
            ],
            customScripts: [
                function() {
                    // кастомный скрипт
                },

                // другие скрипты...
            ],
            customGui: {
                // DEPRECATED (этот параметр устарел)
                // дополнительные элементы управления для GUI-режима
                // используйте plugins (плагины для отчета) вместо customGui
            },
            pluginsEnabled: true,
            plugins: [
                // плагины для отчета...
            ],
            yandexMetrika: {
                counter: 1234567
            }
        },

        // другие плагины гермионы...
    },

    // другие настройки гермионы...
}
```

### Расшифровка параметров конфигурации

| **Параметр** | **Тип** | **По&nbsp;умолчанию** | **Описание** |
| ------------ | ------- | :-------------------: | ------------ |
| [enabled](#enabled) | Boolean | true | Включить / отключить плагин. |
| [path](#path) | String | "html-report" | Путь к папке для сохранения файлов html-отчета. |
| [saveErrorDetails](#saveerrordetails) | Boolean | false | Сохранять / не сохранять подробности ошибок в json-файлах. |
| [uiMode](#uimode) | String | `null` | Режим интерфейса по умолчанию: "old" для классического интерфейса, "new" для современного интерфейса. |
| [defaultView](#defaultview) | String | "all" | Режим фильтрации тестов при отображении, который будет установлен по умолчанию. |
| [diffMode](#diffmode) | String | "3-up" | Режим просмотра диффов, который будет установлен по умолчанию. |
| [baseHost](#basehost) | String | _N/A_ | Заменяет оригинальный адрес хоста для просмотра в браузере. |
| [errorPatterns](#errorpatterns) | Object[] или String[] | [ ] | Паттерны ошибок с подсказками для улучшения UX отчета. |
| [metaInfoBaseUrls](#metainfobaseurls) | Object | `{ }` | Базовые URL-адреса для формирования ссылок в разделе _Meta_ на основе мета-информации о прогоне теста. |
| [saveFormat](#saveformat) | String | "sqlite" | ПАРАМЕТР УСТАРЕЛ. Позволяет задать формат, в котором будут сохранены результаты прогона тестов. |
| [customGui](#customgui) | Object | `{ }` | ПАРАМЕТР УСТАРЕЛ. Используйте вместо него [plugins](#plugins). Описание собственных элементов управления для GUI-режима. |
| [pluginsEnabled](#pluginsenabled) | Boolean | false | Включить плагины для отчета. |
| [plugins](#plugins) | Object[] | [ ] | Список плагинов с их настройками. |
| [customScripts](#customscripts) | Function[] | [ ] | Список функций, реализующих кастомные скрипты. Например, скрипты Яндекс.Метрики или Жучка.|
| [yandexMetrika](#yandexmetrika) | Object | `{ }` | [Яндекс.Метрика][yandex-metrika]. |

### enabled

Включает или отключает плагин.

### path

Путь к папке для сохранения файлов html-отчета. По умолчанию файлы будут сохранены в папку `html-report` в текущей рабочей папке.

### saveErrorDetails

Сохранять или не сохранять подробности ошибок в json-файлах (в папку `error-details`).

По умолчанию «не сохранять»: `false`.

Любой плагин гермионы может добавить какие-либо подробности в объект ошибки при её возникновении. Эти подробности могут помочь пользователю в отладке проблем, которые возникли в тесте. Html-reporter сохраняет эти детали в папке `error-details` в файле с именем: `<хэш от полного названия теста>-<браузер>_<номер ретрая>_<временная метка>.json`.

Под стектрейсом html-reporter добавляет раздел `Error details` со ссылкой `<title>`, указывающей на json-файл. Пользователь может открыть этот файл либо в браузере, либо в любой IDE.

Пример как добавить подробности в объект ошибки из плагина:

```javascript
const err = new Error('some error');

err.details = {
    title: 'description, will be used as url title',
    data: {} // или [], или String
};

throw err;
```

### uiMode

Режим интерфейса по умолчанию: "old" для классического интерфейса, "new" для современного интерфейса. Влияет на редиректы между старым и новым интерфейсом.

По умолчанию редиректы не выполняются.

Доступны следующие значения: `"old"`, `"new"`.

Например, если установлено значение `"new"`, то пользователи будут перенаправляться на новый интерфейс при попытке доступа к старому интерфейсу. Однако, если пользователь вручную нажмет кнопку "вернуться к старому интерфейсу", эта настройка будет запомнена и он всегда будет использовать старый интерфейс, пока не переключится обратно.

### defaultView

Режим фильтрации тестов при отображении, который будет установлен по умолчанию. Доступны следующие значения:

| **Режим** | **Описание** |
| --------- | ------------ |
| all | все тесты |
| passed | только успешные тесты |
| failed | только упавшие тесты |
| retried | только те тесты, в которых были ретраи (повторные запуски) |
| skipped | только отключенные (заскипанные) тесты |

По умолчанию: `all`, то есть если параметр не задан, то будут показываться все тесты.

### diffMode

Режим просмотра диффов, который будет установлен по умолчанию. Доступны следующие значения:

| **Режим** | **Описание** |
| --------- | ------------ |
| 3-up | все изображения _(expected, actual, diff)_ в одном столбце, друг под другом |
| 3&#8209;up&#8209;scaled | все изображения _(expected, actual, diff)_ в один ряд так, чтобы они помещались на экране |
| only-diff | только дифф _(diff)_ |
| switch | эталонное изображение с возможностью переключаться на актуальное изображение по клику мыши |
| swipe | актуальное изображение поверх эталонного, с разделителем открывающим эталонное изображение |
| onion-skin | актуальное изображение поверх эталонного с возможностью менять прозрачность актуального изображения |

По умолчанию: `3-up`.

### baseHost

Заменяет оригинальный адрес хоста для просмотра в браузере. По умолчанию оригинальный адрес хоста не изменяется.

### errorPatterns

Паттерны ошибок используются:

* чтобы показать более понятную информацию об ошибках, если они соответствуют паттернам, для которых есть подробное описание;
* в режиме отображения `Group by` с выбранным ключом `error`.

Паттерны ошибок можно задавать как в виде объектов, так и в виде строк.

Чтобы задать паттерн ошибки в виде объекта, используйте следующий формат:

```javascript
{
    name: '<название ошибки>',
    pattern: '<паттерн ошибки>',
    hint: '<подсказка пользователю>'
}
```

где:

| **Параметр** | **Тип** | **Описание** |
| ------------ | ------- | ------------ |
| name | String | Название ошибки. |
| pattern | String или RegExp | Регулярное выражение или обычная строка, которой должна соответствовать ошибка. |
| hint | String | Необязательный параметр. Подсказка, что можно сделать с данной ошибкой: почему она возникла, как её исправить и т. п. |

Если паттерн ошибки задан в виде строки, например: `<ошибка>`, то эта строка автоматически рассматривается как объект вида:

```javascript
{
    name: '<ошибка>',
    pattern: '<ошибка>'
}
```

Такой способ задания паттерна удобен для тех ошибок, у которых `name` и `pattern` полностью совпадают.

Когда один из шаблонов ошибок совпадает с сообщением об ошибке, то:

* `name` шаблона ошибки будет отображаться как заголовок сообщения об ошибке, а исходное сообщение об ошибке будет скрыто под катом;
* `hint` для ошибки будет отображаться после поля ошибки `stack`. Подсказка может быть задана в виде html-строки. Например, `<div>some-useful-hint</div>`.

В режиме `Group by` _(группировать по)_ с выбранным ключом `error` тест будет связан с группой, если ошибка теста совпадает с шаблоном ошибок группы. Если тест не может быть связан с существующими группами, то будет создана новая группа.

### metaInfoBaseUrls

Базовые URL-адреса для формирования ссылок в разделе `Meta` на основе мета-информации о прогоне теста.

Параметр задается в виде объекта:

```javascript
{
    '<опция-1>': 'значение опции 1',
    '<опция-2>': 'значение опции 2',
    // и т. д.
}
```

Например:

```javascript
{
    'file': 'base/path'
}
```

Когда значение любого ключа установлено на `auto`, базовый URL будет установлен на базовый хост, указанный в интерфейсе отчета, или останется неизменным, если базовый хост не указан.

Например, если у вас есть следующее значение `metaInfoBaseUrls`:

```javascript
{ custom_url: 'auto' }
```

И вы установите поле `meta.custom_url` в `https://example.com/some/path` в ваших тестах, вы увидите в мете:
- Ссылку на `https://example.com/some/path`, если базовый хост не установлен в интерфейсе пользователя
- Ссылку на `https://another-host.com/some/path`, если базовый хост в интерфейсе пользователя установлен в `https://another-host.com`

### saveFormat

**Параметр устарел**

Позволяет задать формат, в котором будут сохранены результаты прогона тестов.

Доступным осталось только одно значение, которое используется по умолчанию:
* `sqlite` &mdash; сохранить результаты прогона тестов в базе данных формата SQLite.

### customGui

**Параметр устарел**

:warning: _Вместо customGui рекомендуется использовать [плагины для отчета](#plugins)._

Описание собственных элементов управления для GUI-режима.

Смотрите подробнее в разделе «[Кастомизация GUI](./html-reporter-custom-gui.md)».

### pluginsEnabled

Включить плагины для `html-reporter`.

### plugins

Список плагинов с их настройками.

Смотрите подробнее в разделе «[Плагины для отчета](./html-reporter-plugins.md)».

### customScripts

Список кастомных скриптов в виде массива функций. С помощью этого параметра можно добавить любой скрипт на страницу html-отчета. Например, для сбора каких-либо метрик или реализации дополнительной функциональности. Скрипты будут выполнены сразу после рендеринга страницы.

Пример:

```javascript
customScripts: [
    function() {
        console.info('some logs');
    },
    () => {
        const div = document.createElement('div');
        div.innerHTML = 'hello';
        document.body.prepend(div);
    }
]
```

### yandexMetrika

По умолчанию выполняется сбор анонимных сведений об использовании интерфейса отчета в целях анализа и улучшения UX. Собираются такие сведения, как скорость загрузки отчета, частота использования некоторых функций (например, сортировка тестов) и клики по элементам управления. Сведения о вашем проекте или содержимом тестов НЕ собираются ни при каких обстоятельствах.

Если вы не хотите делиться аналитикой с нами, вы можете отключить это любым из способов:

- В конфиге
    ```javascript
    module.exports = {
        plugins: {
            'html-reporter/testplane': {
                yandexMetrika: {
                    enabled: false
                },
                // другие настройки html-reporter...
            },
            // другие плагины Testplane...
        },
        // другие настройки Testplane...
    };
    ```
- С помощью переменных окружения: `html_reporter_yandex_metrika_enabled=false` или просто `NO_ANALYTICS=true`
- С помощью аргументов CLI: `--html-reporter-yandex_metrika_enabled=false`

### Передача параметров через CLI

Все параметры плагина, которые можно определить в конфиге, можно также передать в виде опций командной строки или через переменные окружения во время запуска гермионы. Используйте префикс `--html-reporter-` для опций командной строки и `html_reporter_` &mdash; для переменных окружения.

Например, параметр настроек [path](#path) можно передать следующими способами:

```bash
hermione path/to/mytest.js --html-reporter-path custom/dir
```

```bash
html_reporter_path=custom/dir hermione path/to/mytest.js
```

## Хранение данных

Как уже было сказано выше, `html-reporter` сохраняет результаты прогона тестов в базу данных [SQLite][sqlite].

Почему мы используем SQLite? Потому что он:

* бессерверный, легко подключаемый и не требует настроек
* кросс-платформенный, запускается на любой операционной системе
* одно-файловый, легко переиспользовать отчеты и делиться ими
* быстрее, чем если хранить отчет на файловой системе
* компактный и имеет полноценный SQL.

Файлы, который создаются во время выполнения тестов:

* `sqlite.db` &mdash; база данных Sqlite с результатами прогона тестов
* `data.js` &mdash; конфиг отчета
* `databaseUrls.json` &mdash; абсолютные или относительные URL-адреса на базы данных SQLite (`sqlite.db`) и/или URL-адреса других файлов `databaseUrls.json` (см. команду [merge-reports][merge-reports])

[html-reporter]: https://github.com/gemini-testing/html-reporter
[hermione]: https://github.com/gemini-testing/hermione
[sqlite]: https://www.sqlite.org/index.html
[yandex-metrika]: https://yandex.ru/support/metrica/index.html
[yandex-metrika-goals]: https://yandex.ru/support/metrica/general/goals.html
[how-to-create-counter]: https://yandex.ru/support/metrica/general/creating-counter.html
[merge-reports]: ./html-reporter-commands.md#merge-reports
[http-server]: https://github.com/http-party/http-server#http-server-a-simple-static-http-server
