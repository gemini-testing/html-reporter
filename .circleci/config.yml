version: 2
jobs:
  build:
    working_directory: ~/html-reporter
    docker:
      - image: cimg/node:16.20-browsers

    steps:
      - checkout

      - run: npm ci

      - run:
          name: Download Chromium
          command: >-
            cd test/func/docker/browser-utils &&
            npm ci &&
            node download-chromium.js &&
            CHROME_PATH=$(node download-chromium.js |& grep '^/home') &&
            echo $CHROME_PATH &&
            CHROME_PATH=$(dirname $CHROME_PATH) &&
            mkdir ~/browsers &&
            mv $CHROME_PATH ~/browsers/chrome-linux

      - run:
          name: Download Selenium
          command: npm install selenium-standalone@9.1.1 -g
      - run:
          name: Start Selenium
          command: >-
            selenium-standalone install --drivers.chrome.version=$CHROME_VERSION &&
            selenium-standalone start --drivers.chrome.version=$CHROME_VERSION
          background: true
          environment:
            CHROME_VERSION: 116

      - run:
          name: Functional tests
          command: npm run e2e

      - store_artifacts:
          path: reports/
          destination: /reports
