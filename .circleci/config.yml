version: 2
jobs:
  build:
    docker:
      - image: cimg/node:16.20-browsers

    steps:
      - checkout:
          path: 'html-reporter'

      - run: cd html-reporter && npm ci

      - run:
          name: Download Chromium
          command: >-
            cd test/func/docker/browser-utils &&
            npm ci &&
            CHROME_PATH=$(node download-chromium.js |& grep '^/home') &&
            CHROME_PATH=$(dirname $CHROME_PATH) &&
            mkdir ~/browsers &&
            mv $CHROME_PATH ~/browsers/chrome-linux
            cd ~/html-reporter

      - run:
          name: Download Selenium
          command: npm install selenium-standalone@9.1.1 -g
      - run:
          name: Start Selenium
          command: >-
            selenium-standalone install --drivers.chrome.version=116 &&
            selenium-standalone start --drivers.chrome.version=116
          background: true

      - run:
          name: Functional tests
          command: npm run e2e

      - store_artifacts:
          path: reports/
          destination: /reports
